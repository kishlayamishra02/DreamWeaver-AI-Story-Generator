<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamWeaver - AI Story Generator</title>
    <!-- PNG fallback for modern browsers -->
    <link rel="icon" href="logo.png" sizes="32x32" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dotenv@16.3.1/dist/dotenv.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Poppins:wght@300;400;600&display=swap');
        
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --accent: #0f3460;
            --highlight: #e94560;
            --text-primary: #f1f1f1;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .story-card {
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--accent) 100%);
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.25);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            will-change: transform;
        }
        
        .story-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        .choice-btn {
            background: rgba(15, 52, 96, 0.8);
            border: 2px solid var(--highlight);
            transition: all 0.25s ease;
            opacity: 1 !important;
            position: relative;
            overflow: hidden;
            z-index: 1;
        }
        
        .choice-btn:hover {
            background: var(--highlight);
            transform: scale(1.03);
        }
        
        .choice-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .choice-btn:hover:before {
            left: 100%;
        }
        
        .character {
            transition: all 0.5s ease;
            filter: drop-shadow(0 5px 10px rgba(233, 69, 96, 0.4));
            will-change: transform;
        }
        
        .character:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 8px 15px rgba(233, 69, 96, 0.5));
        }
        
        .mood-light {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
        }
        
        .mood-dark {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
        }
        
        .mood-mystery {
            background: linear-gradient(135deg, #3a1c71 0%, #d76d77 50%, #ffaf7b 100%);
        }
        
        .mood-romance {
            background: linear-gradient(135deg, #ff758c 0%, #ff7eb3 100%);
        }
        
        .mood-adventure {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .typewriter {
            overflow: hidden;
            border-right: 3px solid var(--highlight);
            white-space: pre-wrap;
            margin: 0 auto;
            letter-spacing: 0.03em;
            animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
        }
        
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--highlight) }
        }
        
        .floating {
            animation: floating 6s ease-in-out infinite;
            transform-origin: center bottom;
        }
        
        @keyframes floating {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(1deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--highlight);
            border-radius: 10px;
        }
        
        /* Loading dots */
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }
        
        /* Center alignment */
        .center-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        .story-content-container {
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* Saved stories modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            border-radius: 1rem;
            padding: 2rem;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
        }
        
        /* Always visible sections */
        .sidebar-section {
            min-height: 200px;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .sidebar-section:hover {
            transform: translateY(-3px);
        }
        
        .empty-section {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.5);
            font-style: italic;
        }
        
        /* New centered layout */
        .main-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1.5rem;
        }
        
        .story-visual-container {
            width: 100%;
            max-width: 850px;
            margin: 0 auto;
        }
        
        .story-text-container {
            width: 100%;
            max-width: 850px;
            margin: 0.5rem auto;
        }
        
        .choices-container {
            width: 100%;
            max-width: 850px;
            margin: 0.5rem auto;
            padding: 0.5rem 0;
        }
        
        /* Responsive improvements */
        @media (max-width: 768px) {
            .story-visual-container {
                height: 220px;
            }
            
            #character1 {
                height: 45vw;
                width: 45vw;
                max-height: 180px;
                max-width: 180px;
            }
            
            #character2 {
                height: 40vw;
                width: 40vw;
                max-height: 160px;
                max-width: 160px;
            }
            
            .choices-container {
                gap: 0.75rem !important;
            }
            
            .choice-btn {
                padding: 0.75rem !important;
            }
        }
        
        /* New loading animation */
        .loading-spinner {
            border-radius: 50%;
            border: 3px solid rgba(233, 69, 96, 0.3);
            border-top: 3px solid var(--highlight);
            transform-origin: center;
        }
        
        /* Improved shadows */
        .lifted-shadow {
            box-shadow: 0 10px 25px -10px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-gradient-to-r from-indigo-900 to-purple-900 py-4 shadow-xl sticky top-0 z-10">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2 cursor-pointer transform hover:scale-105 transition-transform" id="logoHome">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <h1 class="text-2xl md:text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-400 to-purple-300">
                        DreamWeaver
                    </h1>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="savedStoriesBtn" class="px-3 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-full font-medium transition-all flex items-center shadow-md hover:shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                        <span class="hidden sm:inline">Saved Stories</span>
                    </button>
                    <button id="newStoryBtn" class="px-3 py-2 bg-pink-600 hover:bg-pink-700 rounded-full font-medium transition-all flex items-center shadow-md hover:shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        <span class="hidden sm:inline">New Story</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow center-container">
        <div class="main-content">
            <!-- Story Visual Section -->
            <div class="story-visual-container">
                <div id="storyVisual" class="relative rounded-xl overflow-hidden mb-2 h-64 md:h-72 bg-gradient-to-r from-blue-900 to-indigo-900 flex items-center justify-center shadow-lg">
                    <div id="character1" class="character absolute left-1/4 bottom-0 h-56 w-56 bg-gradient-to-br from-blue-400 to-indigo-400 rounded-full opacity-80 floating" style="animation-delay: 0.2s;"></div>
                    <div id="character2" class="character absolute right-1/4 bottom-0 h-48 w-48 bg-gradient-to-br from-indigo-400 to-purple-400 rounded-full opacity-80 floating" style="animation-delay: 0.5s;"></div>
                    <div class="absolute inset-0 bg-black bg-opacity-40 backdrop-filter backdrop-blur-sm flex items-center justify-center">
                        <h2 id="scenePrompt" class="text-2xl md:text-3xl font-bold text-center px-8 text-white drop-shadow-lg">
                            Click "New Story" to begin your adventure!
                        </h2>
                    </div>
                </div>
            </div>
            
            <!-- Story Text Section -->
            <div class="story-text-container">
                <div id="storyContent" class="story-card p-6 mb-2 shadow-xl"> 
                    <div class="flex items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pink-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <h3 class="text-xl font-bold text-pink-400">Your Story</h3>
                    </div>
                    <div id="storyText" class="text-lg leading-relaxed text-center">
                        Welcome to DreamWeaver, where your imagination comes to life! Start by clicking the "New Story" button above to generate the beginning of your unique tale. At each step, you'll get to choose how the story continues.
                    </div>
                </div>
            </div>
            
            <!-- Choices Section -->
            <div class="choices-container">
                <div id="choicesContainer" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <!-- Choices will be inserted here by JavaScript -->
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden text-center py-4">
                <div class="inline-block loading-spinner animate-spin rounded-full h-12 w-12 mb-4"></div>
                <p class="text-lg font-medium">Weaving your story<span class="loading-dots"></span></p>
            </div>
            
            <!-- Sidebar Sections -->
            <div class="flex flex-col md:flex-row gap-6 w-full max-w-6xl mt-6">
                <!-- Story History -->
                <div class="story-card p-6 sidebar-section flex-1">
                    <div class="flex items-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <h3 class="text-xl font-bold text-yellow-300">Story History</h3>
                    </div>
                    <div id="storyHistory" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                        <div class="empty-section">
                            <p>Your story history will appear here</p>
                        </div>
                    </div>
                </div>
                
                <!-- Visual Prompt -->
                <div class="story-card p-6 sidebar-section flex-1">
                    <div class="flex items-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-400 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                        </svg>
                        <h3 class="text-xl font-bold text-green-300">Visual Prompt</h3>
                    </div>
                    <div id="visualPrompt" class="bg-gray-800 rounded-lg p-4 italic text-gray-300 text-center">
                        A mystical landscape with floating islands and glowing crystals, where two mysterious figures meet for the first time.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Saved Stories Modal -->
    <div id="savedStoriesModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-300">Your Saved Stories</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white transform hover:rotate-90 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="savedStoriesList" class="space-y-3">
                <!-- Default story will be inserted here -->
                <div class="bg-gray-800 bg-opacity-70 p-4 rounded-lg hover:bg-opacity-90 transition-all">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-pink-300">Welcome to DreamWeaver</h3>
                            <p class="text-sm text-gray-400">Just now</p>
                        </div>
                    </div>
                    <p class="mt-2 text-sm">Create your first story to see it appear here!</p>
                    <div class="mt-2 flex justify-between items-center text-xs">
                        <span class="bg-gray-700 px-2 py-1 rounded">0 segments</span>
                        <span class="bg-blue-500 px-2 py-1 rounded capitalize">neutral</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gradient-to-r from-gray-900 to-gray-800 py-4 text-gray-400 mt-8 shadow-inner">
        <div class="container mx-auto px-4 text-center">
            <p class="mb-1">Â© 2025 CyberGenx | DreamWeaver AI Story Generator</p>
            <p class="text-xs">Powered by <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400">Groq's Lightning-Fast AI</span></p>
        </div>
    </footer>

    <script>
        // Load API key from environment variable (for local development)
        let API_KEY = '';
        
        // Function to fetch and load environment variables
        async function loadEnvVars() {
            try {
                const response = await fetch('API.env');
                if (response.ok) {
                    const text = await response.text();
                    const keyMatch = text.match(/API_KEY=(.+)/);
                    if (keyMatch && keyMatch[1]) {
                        API_KEY = keyMatch[1].trim();
                        console.log("API key loaded successfully");
                    }
                }
            } catch (error) {
                console.error("Failed to load environment variables:", error);
            }
            
            // Fall back to a placeholder if no API key found
            if (!API_KEY) {
                console.warn("No API key found. API requests will fail.");
                API_KEY = "YOUR_API_KEY_HERE";
            }
        }
        
        // DOM Elements
        const newStoryBtn = document.getElementById('newStoryBtn');
        const savedStoriesBtn = document.getElementById('savedStoriesBtn');
        const logoHome = document.getElementById('logoHome');
        const storyText = document.getElementById('storyText');
        const choicesContainer = document.getElementById('choicesContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const storyHistory = document.getElementById('storyHistory');
        const visualPrompt = document.getElementById('visualPrompt');
        const scenePrompt = document.getElementById('scenePrompt');
        const storyVisual = document.getElementById('storyVisual');
        const character1 = document.getElementById('character1');
        const character2 = document.getElementById('character2');
        const savedStoriesModal = document.getElementById('savedStoriesModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const savedStoriesList = document.getElementById('savedStoriesList');
        
        // Story state
        let currentStory = {
            title: '',
            segments: [],
            currentSegment: null,
            choices: [],
            visualPrompt: '',
            mood: 'neutral',
            timestamp: null
        };
        
        // Mood colors
        const moods = {
            happy: 'from-yellow-400 to-orange-400',
            dark: 'from-gray-800 to-gray-900',
            mystery: 'from-purple-800 to-indigo-900',
            romance: 'from-pink-500 to-red-500',
            adventure: 'from-green-500 to-blue-500',
            neutral: 'from-blue-900 to-indigo-900'
        };
        
        // Character colors for each mood
        const characterColors = {
            happy: ['from-yellow-300 to-amber-300', 'from-orange-300 to-pink-300'],
            dark: ['from-gray-700 to-gray-800', 'from-gray-600 to-gray-700'],
            mystery: ['from-purple-600 to-indigo-600', 'from-blue-500 to-indigo-500'],
            romance: ['from-pink-400 to-rose-400', 'from-rose-400 to-red-400'],
            adventure: ['from-green-400 to-teal-400', 'from-blue-400 to-cyan-400'],
            neutral: ['from-blue-400 to-indigo-400', 'from-indigo-400 to-purple-400']
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadEnvVars(); // Load API key first
            loadSavedStories();
            checkForAutoSave();
            generateRandomPrompt(); // Generate initial random prompt
            
            // GSAP animations
            gsap.from("header", { duration: 0.8, y: -50, opacity: 0, ease: "power2.out" });
            gsap.from("#storyVisual", { duration: 1, scale: 0.9, opacity: 0, ease: "back.out(1.7)" });
            gsap.from("#storyContent", { duration: 0.8, x: -50, opacity: 0, delay: 0.3, ease: "power2.out" });
            gsap.from(".story-card", { duration: 0.6, y: 30, opacity: 0, stagger: 0.2, delay: 0.5, ease: "back.out(1.2)" });
        });
        
        // Event Listeners
        newStoryBtn.addEventListener('click', startNewStory);
        savedStoriesBtn.addEventListener('click', showSavedStories);
        logoHome.addEventListener('click', returnToHome);
        closeModalBtn.addEventListener('click', () => savedStoriesModal.classList.add('hidden'));
        
        // Functions
        async function generateRandomPrompt() {
            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama3-70b-8192",
                        messages: [{
                            role: "system",
                            content: "Generate a vivid visual prompt for a story scene in one sentence. Be creative and imaginative."
                        }],
                        temperature: 0.9,
                        max_tokens: 100
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const prompt = data.choices[0].message.content;
                visualPrompt.textContent = prompt;
                
            } catch (error) {
                console.error("Error generating random prompt:", error);
                visualPrompt.textContent = "A mystical landscape with floating islands and glowing crystals, where two mysterious figures meet for the first time.";
            }
        }
        
        async function startNewStory() {
            showLoading(true);
            
            try {
                const response = await generateStory("Begin a new story with an interesting premise. Provide 3 choices for what happens next.");
                
                if (response.choices && response.choices.length > 0) {
                    currentStory = {
                        title: response.title || "Untitled Adventure",
                        segments: [response.initialSegment],
                        currentSegment: response.initialSegment,
                        choices: response.choices,
                        visualPrompt: response.visualPrompt,
                        mood: response.mood || 'neutral',
                        timestamp: new Date().toISOString()
                    };
                    
                    updateStoryDisplay();
                    updateVisualPrompt(response.visualPrompt);
                    updateMood(response.mood || 'neutral');
                    addToHistory(response.initialSegment, true);
                    
                    // Auto-save the new story
                    autoSaveStory();
                    
                    // Animation
                    animateNewStory();
                }
            } catch (error) {
                console.error("Error generating story:", error);
                storyText.innerHTML = `<p class="text-red-400">Oops! Something went wrong. Please try again.</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        async function makeChoice(choiceIndex) {
            showLoading(true);
            
            try {
                const selectedChoice = currentStory.choices[choiceIndex];
                const response = await generateStory(`Continue the story with this choice: ${selectedChoice.text}. Provide 3 new choices.`);
                
                currentStory.segments.push(response.initialSegment);
                currentStory.currentSegment = response.initialSegment;
                currentStory.choices = response.choices;
                currentStory.visualPrompt = response.visualPrompt;
                currentStory.mood = response.mood || 'neutral';
                
                updateStoryDisplay();
                updateVisualPrompt(response.visualPrompt);
                updateMood(response.mood || 'neutral');
                addToHistory(response.initialSegment);
                
                // Auto-save after each choice
                autoSaveStory();
                
                // Animation
                animateChoiceSelection(choiceIndex);
            } catch (error) {
                console.error("Error making choice:", error);
                storyText.innerHTML += `<p class="text-red-400 mt-4">Oops! Something went wrong. Please try again.</p>`;
            } finally {
                showLoading(false);
            }
        }
        
        function updateStoryDisplay() {
            // Update main story text
            storyText.innerHTML = `<p class="typewriter">${currentStory.currentSegment}</p>`;
            
            // Update choices with full opacity
            choicesContainer.innerHTML = '';
            currentStory.choices.forEach((choice, index) => {
                const choiceBtn = document.createElement('button');
                choiceBtn.className = 'choice-btn p-4 rounded-lg text-lg font-medium text-center flex items-center justify-center opacity-100';
                choiceBtn.innerHTML = `
                    <span class="mr-2">${index + 1}.</span> ${choice.text}
                `;
                choiceBtn.addEventListener('click', () => makeChoice(index));
                choicesContainer.appendChild(choiceBtn);
            });
            
            // Update scene prompt
            scenePrompt.textContent = extractPromptFromSegment(currentStory.currentSegment);
            
            // Scroll to choices if needed
            setTimeout(() => {
                choicesContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 500);
        }
        
        function updateVisualPrompt(prompt) {
            visualPrompt.textContent = prompt || "A mysterious scene unfolds...";
            
            // Animate the visual prompt
            gsap.from(visualPrompt, {
                duration: 0.5,
                y: 20,
                opacity: 0,
                ease: "power2.out"
            });
        }
        
        function updateMood(mood) {
            // Reset all mood classes
            storyVisual.className = 'relative rounded-xl overflow-hidden mb-2 h-64 flex items-center justify-center';
            
            // Add the selected mood gradient
            const moodClasses = moods[mood] || moods.neutral;
            storyVisual.classList.add(...moodClasses.split(' '));
            
            // Update character colors based on mood
            updateCharacterColors(mood);
        }
        
        function updateCharacterColors(mood) {
            const selectedColors = characterColors[mood] || characterColors.neutral;
            character1.className = `character absolute left-1/4 bottom-0 h-56 w-56 rounded-full opacity-80 floating ${selectedColors[0]}`;
            character2.className = `character absolute right-1/4 bottom-0 h-48 w-48 rounded-full opacity-80 floating ${selectedColors[1]}`;
        }
        
        function addToHistory(segment, isNew = false) {
            // Remove empty state if present
            if (storyHistory.querySelector('.empty-section')) {
                storyHistory.innerHTML = '';
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'bg-gray-800 bg-opacity-50 p-3 rounded-lg border-l-4 border-pink-500';
            
            if (isNew) {
                historyItem.innerHTML = `
                    <div class="flex items-center text-pink-400 mb-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        <span class="text-xs font-bold">BEGINNING</span>
                    </div>
                    <p class="text-sm line-clamp-2">${extractPromptFromSegment(segment)}</p>
                `;
            } else {
                historyItem.innerHTML = `
                    <p class="text-sm line-clamp-2">${extractPromptFromSegment(segment)}</p>
                `;
            }
            
            // Add to top of history
            if (storyHistory.firstChild) {
                storyHistory.insertBefore(historyItem, storyHistory.firstChild);
            } else {
                storyHistory.appendChild(historyItem);
            }
            
            // Limit history to 10 items
            if (storyHistory.children.length > 10) {
                storyHistory.removeChild(storyHistory.lastChild);
            }
        }
        
        function extractPromptFromSegment(segment) {
            // Extract the first sentence or a short description
            const sentences = segment.split(/[.!?]+/);
            return sentences[0] || segment.substring(0, 100) + (segment.length > 100 ? '...' : '');
        }
        
        function autoSaveStory() {
            try {
                const stories = JSON.parse(localStorage.getItem('dreamweaverStories') || '[]');
                
                // Check if this story already exists
                const existingIndex = stories.findIndex(s => s.timestamp === currentStory.timestamp);
                
                if (existingIndex >= 0) {
                    // Update existing story
                    stories[existingIndex] = currentStory;
                } else {
                    // Add new story
                    stories.unshift(currentStory); // Add to beginning of array
                }
                
                // Keep only the 5 most recent stories
                const recentStories = stories.slice(0, 5);
                localStorage.setItem('dreamweaverStories', JSON.stringify(recentStories));
                
                // Show auto-save indicator
                const autoSaveDiv = document.createElement('div');
                autoSaveDiv.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-lg';
                autoSaveDiv.textContent = 'Auto-saved';
                document.body.appendChild(autoSaveDiv);
                
                setTimeout(() => {
                    gsap.to(autoSaveDiv, {
                        y: 20,
                        opacity: 0,
                        duration: 0.5,
                        ease: "power2.out",
                        onComplete: () => autoSaveDiv.remove()
                    });
                }, 2000);
            } catch (error) {
                console.error("Error auto-saving story:", error);
            }
        }
        
        function loadSavedStories() {
            try {
                return JSON.parse(localStorage.getItem('dreamweaverStories') || '[]');
            } catch (error) {
                console.error("Error loading saved stories:", error);
                return [];
            }
        }
        
        function checkForAutoSave() {
            const stories = loadSavedStories();
            if (style.length > 0) { // let it be style.lenght, and don't change it to stories.length
                // Check if there's an active story (most recent)
                const mostRecent = stories[0]; // Now using unshift, so first item is most recent
                
                // Show resume prompt
                const resumeDiv = document.createElement('div');
                resumeDiv.className = 'fixed bottom-4 left-4 bg-indigo-600 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center cursor-pointer';
                resumeDiv.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Resume your story
                `;
                resumeDiv.addEventListener('click', () => {
                    loadStory(mostRecent);
                    resumeDiv.remove();
                });
                document.body.appendChild(resumeDiv);
                
                // Auto-remove after 10 seconds
                setTimeout(() => {
                    gsap.to(resumeDiv, {
                        x: -20,
                        opacity: 0,
                        duration: 0.5,
                        ease: "power2.out",
                        onComplete: () => resumeDiv.remove()
                    });
                }, 10000);
            }
        }
        
        function loadStory(storyData) {
            currentStory = storyData;
            updateStoryDisplay();
            updateVisualPrompt(storyData.visualPrompt);
            updateMood(storyData.mood || 'neutral');
            
            // Clear and rebuild history
            storyHistory.innerHTML = '';
            storyData.segments.forEach((segment, index) => {
                addToHistory(segment, index === 0);
            });
            
            // Animation
            animateNewStory();
        }
        
        function showSavedStories() {
            savedStoriesList.innerHTML = '';
            const stories = loadSavedStories();
            
            if (stories.length === 0) {
                // Keep the default story display
                savedStoriesList.innerHTML = `
                    <div class="bg-gray-800 bg-opacity-70 p-4 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg">Welcome to DreamWeaver</h3>
                                <p class="text-sm text-gray-400">Just now</p>
                            </div>
                        </div>
                        <p class="mt-2 text-sm">Create your first story to see it appear here!</p>
                        <div class="mt-2 flex justify-between items-center text-xs">
                            <span class="bg-gray-700 px-2 py-1 rounded">0 segments</span>
                            <span class="bg-blue-500 px-2 py-1 rounded capitalize">neutral</span>
                        </div>
                    </div>
                `;
            } else {
                stories.forEach((story, index) => {
                    const storyItem = document.createElement('div');
                    storyItem.className = 'bg-gray-800 bg-opacity-70 p-4 rounded-lg hover:bg-opacity-100 transition-all cursor-pointer group';
                    storyItem.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-lg group-hover:text-pink-400 transition-colors">${story.title || 'Untitled Story'}</h3>
                                <p class="text-sm text-gray-400">${new Date(story.timestamp).toLocaleString()}</p>
                            </div>
                            <button class="delete-story-btn p-1 text-gray-500 hover:text-red-500" data-timestamp="${story.timestamp}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        <p class="mt-2 text-sm line-clamp-2">${extractPromptFromSegment(story.segments[0])}</p>
                        <div class="mt-2 flex justify-between items-center text-xs">
                            <span class="bg-gray-700 px-2 py-1 rounded">${story.segments.length} segment${story.segments.length !== 1 ? 's' : ''}</span>
                            <span class="bg-${story.mood === 'dark' ? 'gray' : story.mood === 'romance' ? 'pink' : story.mood}-500 px-2 py-1 rounded capitalize">${story.mood}</span>
                        </div>
                    `;
                    
                    storyItem.addEventListener('click', () => {
                        loadStory(story);
                        savedStoriesModal.classList.add('hidden');
                    });
                    
                    savedStoriesList.appendChild(storyItem);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-story-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteStory(btn.dataset.timestamp);
                    });
                });
            }
            
            savedStoriesModal.classList.remove('hidden');
        }
        
        function deleteStory(timestamp) {
            const stories = loadSavedStories();
            const updatedStories = stories.filter(s => s.timestamp !== timestamp);
            localStorage.setItem('dreamweaverStories', JSON.stringify(updatedStories));
            
            // Refresh the modal
            showSavedStories();
            
            // Show deletion confirmation
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed bottom-4 right-4 bg-red-500 text-white px-4 py-2 rounded-full text-sm font-bold shadow-lg flex items-center';
            confirmDiv.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Story deleted
            `;
            document.body.appendChild(confirmDiv);
            
            setTimeout(() => {
                gsap.to(confirmDiv, {
                    y: 20,
                    opacity: 0,
                    duration: 0.5,
                    ease: "power2.out",
                    onComplete: () => confirmDiv.remove()
                });
            }, 2000);
        }
        
        function returnToHome() {
            // Reset to initial state
            currentStory = {
                title: '',
                segments: [],
                currentSegment: null,
                choices: [],
                visualPrompt: '',
                mood: 'neutral',
                timestamp: null
            };
            
            storyText.innerHTML = 'Welcome to DreamWeaver, where your imagination comes to life! Start by clicking the "New Story" button above to generate the beginning of your unique tale. At each step, you\'ll get to choose how the story continues.';
            choicesContainer.innerHTML = '';
            storyHistory.innerHTML = '<div class="empty-section"><p>Your story history will appear here</p></div>';
            generateRandomPrompt(); // Generate new random prompt
            scenePrompt.textContent = 'Click "New Story" to begin your adventure!';
            updateMood('neutral');
            
            // Animation
            gsap.from("#storyVisual", {
                duration: 1,
                scale: 0.95,
                opacity: 0.5,
                ease: "back.out(1.7)"
            });
        }
        
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
                choicesContainer.classList.add('hidden');
                storyText.innerHTML = '<p class="opacity-50">Loading next chapter...</p>';
            } else {
                loadingIndicator.classList.add('hidden');
                choicesContainer.classList.remove('hidden');
            }
        }
        
        function animateNewStory() {
            // Visual animation
            gsap.from("#storyVisual", {
                duration: 1,
                scale: 0.95,
                opacity: 0.5,
                ease: "back.out(1.7)"
            });
            
            // Character animations
            gsap.from(character1, {
                duration: 1,
                x: -100,
                opacity: 0,
                delay: 0.3,
                ease: "elastic.out(1, 0.5)"
            });
            
            gsap.from(character2, {
                duration: 1,
                x: 100,
                opacity: 0,
                delay: 0.5,
                ease: "elastic.out(1, 0.5)"
            });
            
            // Text animation
            gsap.from("#storyText p", {
                duration: 0.8,
                y: 20,
                opacity: 0,
                ease: "power2.out"
            });
        }
        
        function animateChoiceSelection(choiceIndex) {
            // Animate the selected choice
            const choiceBtns = choicesContainer.querySelectorAll('button');
            gsap.to(choiceBtns[choiceIndex], {
                duration: 0.3,
                scale: 0.95,
                backgroundColor: '#e94560',
                color: '#ffffff',
                ease: "power2.in"
            });
            
            // Animate other choices fading out
            choiceBtns.forEach((btn, index) => {
                if (index !== choiceIndex) {
                    gsap.to(btn, {
                        duration: 0.3,
                        opacity: 0.3,
                        scale: 0.9,
                        ease: "power2.in"
                    });
                }
            });
            
            // Animate new content coming in
            setTimeout(() => {
                gsap.from("#storyText p", {
                    duration: 0.8,
                    y: 20,
                    opacity: 0,
                    ease: "power2.out"
                });
                
                gsap.from(choiceBtns, {
                    duration: 0.6,
                    y: 20,
                    opacity: 0,
                    stagger: 0.1,
                    ease: "back.out(1.2)"
                });
            }, 300);
        }
        
        // Corrected Groq API implementation
        async function generateStory(userPrompt) {
            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "llama3-70b-8192",
                        messages: [{
                            role: "system",
                            content: `You are a creative writing assistant. Generate a story segment and 3 choices in JSON format. Follow this structure:
                            {
                                "initialSegment": "engaging story text",
                                "choices": [{"text": "option1"}, {"text": "option2"}, {"text": "option3"}],
                                "visualPrompt": "vivid description for scene visualization",
                                "mood": "mystery/romance/adventure/etc",
                                "title": "Story Title"
                            }
                            Return only valid JSON with no additional text.`
                        }, {
                            role: "user",
                            content: userPrompt
                        }],
                        temperature: 0.7,
                        max_tokens: 1000,
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                // Parse the JSON content from the response
                let content;
                try {
                    content = JSON.parse(data.choices[0].message.content);
                } catch (e) {
                    // If parsing fails, try to extract JSON from the response
                    const jsonMatch = data.choices[0].message.content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        content = JSON.parse(jsonMatch[0]);
                    } else {
                        throw new Error("Invalid JSON response from API");
                    }
                }

                // Validate response structure
                if (!content.initialSegment || !content.choices || !Array.isArray(content.choices)) {
                    throw new Error("Invalid response structure from API");
                }

                return {
                    initialSegment: content.initialSegment,
                    choices: content.choices.slice(0, 3), // Ensure only 3 choices
                    visualPrompt: content.visualPrompt || "A mysterious scene unfolds...",
                    mood: content.mood || 'neutral',
                    title: content.title || "AI-Generated Adventure"
                };

            } catch (error) {
                console.error("Groq API Error:", error);
                return {
                    initialSegment: "The story portal glitches... Please try again later!",
                    choices: [{ text: "Restart Story" }],
                    visualPrompt: "A fractured digital landscape with glitching reality",
                    mood: "dark",
                    title: "Error Occurred"
                };
            }
        }
    </script>
</body>
</html>